{# ==============================================================================
   COMPONENTE MODULARE: Sedi Aggiuntive (Preview + Espansione Scrollabile)
   ==============================================================================
   Versione: 3.0.0
   Data: 2026-02-11
   Descrizione: Elenco sedi aggiuntive con layout compatto
                - Default: prime 2 righe visibili (preview)
                - Espanso: griglia scrollabile che riempie il riquadro
                - Clic riga espande dettagli
                - Referente cliccabile
                - CRUD: modifica/cancella/rinomina nel dettaglio sede
   
   MODIFICHE v3.0:
   - Rimosso bootstrap collapse
   - Preview 2 righe + espansione scrollabile
   - Espansione nasconde dati aziendali sopra
   - Tasto + ancorato in basso
   
   USO:
   {% include "dettaglio/sedi/_riquadro.html" %}
   
   VARIABILI RICHIESTE:
   - cliente: oggetto cliente con id
   ============================================================================== #}

<!-- Sedi Aggiuntive (preview + espandibile) -->
<div class="mt-2" id="container-sedi" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
    <!-- Header: Altre Sedi + freccia + tasto + -->
    <div class="d-flex align-items-center justify-content-between" style="flex-shrink: 0;">
        <a href="#" class="text-decoration-none text-muted small" onclick="toggleSediExpand(); return false;" id="toggle-sedi">
            <i class="bi bi-chevron-right me-1 collapse-icon-sedi"></i>
            <i class="bi bi-geo-alt me-1"></i>Altre Sedi (<span id="count-sedi">0</span>)
        </a>
        <button type="button" class="btn btn-sm btn-outline-primary py-0 px-1" onclick="apriModalSede()" title="Aggiungi sede">
            <i class="bi bi-plus"></i>
        </button>
    </div>
    
    <!-- Lista sedi (preview o espansa) -->
    <div id="sedi-lista-wrapper" class="mt-1" style="max-height: 70px; overflow: hidden; transition: all 0.3s ease;">
        <div id="lista-sedi">
            <div class="text-center text-muted py-2">
                <div class="spinner-border spinner-border-sm" role="status"></div>
                <small class="ms-2">Caricamento...</small>
            </div>
        </div>
    </div>
</div>

<!-- Modal Aggiungi/Modifica Sede -->
<div class="modal fade" id="modalSede" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title" id="modalSedeTitle">Aggiungi Sede</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="sede-edit-id" value="">
                
                <!-- Switch protezione -->
                <div class="form-check form-switch mb-3" id="sede-protezione-wrapper" style="display:none;">
                    <input class="form-check-input" type="checkbox" id="sede-protetto">
                    <label class="form-check-label" for="sede-protetto">
                        <i class="bi bi-lock-fill text-warning"></i> <strong>Proteggi da sovrascrittura</strong>
                        <small class="text-muted d-block">Se attivo, i prossimi import CRM/Creditsafe non modificheranno questa sede</small>
                    </label>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Tipo Sede</label>
                        <select class="form-select" id="sede-tipo">
                            <option value="Operativa">Operativa</option>
                            <option value="Filiale">Filiale</option>
                            <option value="Magazzino">Magazzino</option>
                            <option value="Deposito">Deposito</option>
                            <option value="Ufficio">Ufficio</option>
                            <option value="Stabilimento">Stabilimento</option>
                            <option value="Punto Vendita">Punto Vendita</option>
                            <option value="Indirizzo Fatturazione">Indirizzo Fatturazione</option>
                            <option value="Altro">Altro</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Denominazione <small class="text-muted">(opz.)</small></label>
                        <input type="text" class="form-control" id="sede-denominazione" placeholder="Es: Filiale Nord">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Indirizzo</label>
                        <input type="text" class="form-control" id="sede-indirizzo" placeholder="Via e numero civico">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">CAP</label>
                        <input type="text" class="form-control" id="sede-cap" maxlength="5">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Citt&agrave;</label>
                        <input type="text" class="form-control" id="sede-citta" style="text-transform: uppercase;">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Prov.</label>
                        <input type="text" class="form-control" id="sede-provincia" maxlength="2" style="text-transform: uppercase;">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Telefono Sede <small class="text-muted">(opz.)</small></label>
                        <input type="text" class="form-control" id="sede-telefono">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email Sede <small class="text-muted">(opz.)</small></label>
                        <input type="email" class="form-control" id="sede-email">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Referente <small class="text-muted">(opz.)</small></label>
                        <select class="form-select" id="sede-referente">
                            <option value="">-- Nessun referente --</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Note <small class="text-muted">(opz.)</small></label>
                        <textarea class="form-control" id="sede-note" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="salvaSede()">Salva</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dettaglio Referente -->
<div class="modal fade" id="modalDettaglioReferente" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="bi bi-person me-1"></i><span id="ref-modal-nome">Referente</span></h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ref-modal-body">
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<style>
.collapse-icon-sedi {
    transition: transform 0.2s;
    display: inline-block;
}
.collapse-icon-sedi.rotated {
    transform: rotate(90deg);
}
.sede-row {
    cursor: default;

    padding: 6px 8px;
    border-radius: 4px;
    margin-bottom: 2px;
    background-color: #f8f9fa;
    font-size: 0.85rem;
}
.sede-row:hover {
    background-color: #e9ecef;
}
.sede-badge {
    font-size: 0.7rem;
    padding: 2px 6px;
}
.sede-badge-click:hover {
    filter: brightness(1.2);
}
.referente-link {
    color: #0d6efd;
    text-decoration: none;
}
.referente-link:hover {
    text-decoration: underline;
}
/* Wrapper sedi espanso */
#sedi-lista-wrapper.sedi-expanded {
    max-height: none !important;
    overflow-y: auto !important;
    flex: 1;
}
</style>

<script>
// Variabile locale per questo componente
const clienteIdSedi = {{ cliente.id }};
let sediCliente = [];
let referentiDisponibili = [];
let sediEspanse = false;

// Carica dati iniziali
document.addEventListener('DOMContentLoaded', function() {
    caricaSedi();
});

// =====================================================================
// TOGGLE ESPANSIONE SEDI
// =====================================================================
function toggleSediExpand() {
    sediEspanse = !sediEspanse;
    
    const wrapper = document.getElementById('sedi-lista-wrapper');
    const datiRows = document.getElementById('dati-aziendali-rows');
    const icon = document.querySelector('.collapse-icon-sedi');
    
    if (sediEspanse) {
        // Espandi: nascondi dati, mostra tutte le sedi scrollabili
        if (datiRows) datiRows.style.display = 'none';
        wrapper.classList.add('sedi-expanded');
        if (icon) icon.classList.add('rotated');
    } else {
        // Comprimi: mostra dati, preview 2 righe
        if (datiRows) datiRows.style.display = '';
        wrapper.classList.remove('sedi-expanded');
        if (icon) icon.classList.remove('rotated');
    }
}

// =====================================================================
// CARICAMENTO E RENDERING SEDI
// =====================================================================
function caricaSedi() {
    fetch(`/api/cliente/${clienteIdSedi}/sedi`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                sediCliente = data.sedi;
                referentiDisponibili = data.referenti || [];
                renderSedi();
                popolaSelectReferenti();
                document.getElementById('count-sedi').textContent = sediCliente.length;
            }
        })
        .catch(err => console.error('Errore caricamento sedi:', err));
}

function popolaSelectReferenti() {
    const select = document.getElementById('sede-referente');
    if (!select) return;
    
    select.innerHTML = '<option value="">-- Nessun referente --</option>';
    referentiDisponibili.forEach(r => {
        const ruolo = r.ruolo ? ` (${r.ruolo})` : '';
        select.innerHTML += `<option value="${r.id}">${r.nome}${ruolo}</option>`;
    });
}

function renderSedi() {
    const container = document.getElementById('lista-sedi');
    
    if (sediCliente.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center py-2 small">
                <i class="bi bi-info-circle me-1"></i>Nessuna sede aggiuntiva
            </div>`;
        return;
    }
    
    let html = '';
    sediCliente.forEach(sede => {
        // Badge tipo
        const tipoBadge = `<span class="badge bg-secondary sede-badge me-2">${sede.tipo_sede}</span>`;
        
        // Nome/Denominazione
        const nome = sede.denominazione || '';
        
        // Contatto: referente OPPURE telefono/email
        let contattoHtml = '';
        if (sede.ref_nome) {
            contattoHtml = ' <span class="text-muted">| <i class="bi bi-person"></i> ' + sede.ref_nome.trim() + '</span>';
        } else {
            let parts = [];
            if (sede.telefono) parts.push('<i class="bi bi-telephone"></i> ' + sede.telefono);
            if (sede.email) parts.push('<i class="bi bi-envelope"></i> ' + sede.email);
            if (parts.length > 0) contattoHtml = ' <span class="text-muted">| ' + parts.join(' ') + '</span>';
        }
        
        // Note (se presenti)
        let noteHtml = '';
        if (sede.note) {
            noteHtml = ' <span class="text-muted fst-italic">| ' + sede.note + '</span>';
        }
        
        // Tooltip completo
        const sedeTooltip = [nome, sede.indirizzo, sede.cap, sede.citta, sede.provincia ? '(' + sede.provincia + ')' : '', sede.telefono, sede.email, sede.ref_nome ? 'Ref: ' + sede.ref_nome.trim() : '', sede.note].filter(Boolean).join(' ');

        // Riga compatta
        html += `
            <div class="sede-row d-flex align-items-center">
                ${tipoBadge}${sede.protetto ? '<span class="badge bg-warning text-dark me-1" title="Protetto da sovrascrittura import"><i class="bi bi-lock-fill"></i></span>' : ''}
                <span class="text-truncate" style="flex: 1; min-width: 0;" title="${sedeTooltip}">
                    ${nome ? '<span class=\"fw-semibold\">' + nome + '</span> ' : ''}${sede.indirizzo || ''} ${sede.cap || ''} ${sede.citta || ''} ${sede.provincia ? '(' + sede.provincia + ')' : ''}${contattoHtml}${noteHtml}
                </span>
                <div class="ms-auto d-flex align-items-center gap-1">
                    <button class="btn btn-outline-primary btn-sm py-0 px-1" onclick="event.stopPropagation(); modificaSede(${sede.id})" title="Modifica">
                        <i class="bi bi-pencil" style="font-size:0.7rem"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm py-0 px-1" onclick="event.stopPropagation(); confermaCancellaSede(${sede.id}, '${(sede.denominazione || sede.citta || '').replace(/'/g, "\\'")}')" title="Elimina">
                        <i class="bi bi-trash" style="font-size:0.7rem"></i>
                    </button>
                </div>
            </div>
`;
    });
    
    container.innerHTML = html;
}



// =====================================================================
// DETTAGLIO REFERENTE (modal)
// =====================================================================
function mostraDettaglioReferente(refId) {
    const ref = referentiDisponibili.find(r => r.id === refId);
    if (!ref) return;
    
    document.getElementById('ref-modal-nome').textContent = ref.nome || 'Referente';
    
    let body = '';
    if (ref.ruolo) body += `<div class="mb-2"><small class="text-muted">Ruolo</small><div>${ref.ruolo}</div></div>`;
    if (ref.cellulare) body += `<div class="mb-2"><small class="text-muted">Cellulare</small><div><a href="tel:${ref.cellulare}">${ref.cellulare}</a></div></div>`;
    if (ref.telefono) body += `<div class="mb-2"><small class="text-muted">Telefono</small><div><a href="tel:${ref.telefono}">${ref.telefono}</a></div></div>`;
    if (ref.email) body += `<div class="mb-2"><small class="text-muted">Email</small><div><a href="mailto:${ref.email}">${ref.email}</a></div></div>`;
    
    document.getElementById('ref-modal-body').innerHTML = body || '<p class="text-muted">Nessun dettaglio disponibile</p>';
    new bootstrap.Modal(document.getElementById('modalDettaglioReferente')).show();
}

// =====================================================================
// CRUD SEDI
// =====================================================================
function apriModalSede() {
    document.getElementById('sede-edit-id').value = '';
    document.getElementById('modalSedeTitle').textContent = 'Aggiungi Sede';
    document.getElementById('sede-protezione-wrapper').style.display = 'none';
    document.getElementById('sede-protetto').checked = false;
    document.getElementById('sede-tipo').value = 'Operativa';
    document.getElementById('sede-denominazione').value = '';
    document.getElementById('sede-indirizzo').value = '';
    document.getElementById('sede-cap').value = '';
    document.getElementById('sede-citta').value = '';
    document.getElementById('sede-provincia').value = '';
    document.getElementById('sede-telefono').value = '';
    document.getElementById('sede-email').value = '';
    document.getElementById('sede-referente').value = '';
    document.getElementById('sede-note').value = '';
    new bootstrap.Modal(document.getElementById('modalSede')).show();
}

function modificaSede(id) {
    const sede = sediCliente.find(s => s.id === id);
    if (!sede) return;
    
    document.getElementById('sede-edit-id').value = id;
    document.getElementById('modalSedeTitle').textContent = 'Modifica Sede';
    document.getElementById('sede-tipo').value = sede.tipo_sede || 'Operativa';
    document.getElementById('sede-denominazione').value = sede.denominazione || '';
    document.getElementById('sede-indirizzo').value = sede.indirizzo || '';
    document.getElementById('sede-cap').value = sede.cap || '';
    document.getElementById('sede-citta').value = sede.citta || '';
    document.getElementById('sede-provincia').value = sede.provincia || '';
    document.getElementById('sede-telefono').value = sede.telefono || '';
    document.getElementById('sede-email').value = sede.email || '';
    document.getElementById('sede-referente').value = sede.referente_id || '';
    document.getElementById('sede-note').value = sede.note || '';
    new bootstrap.Modal(document.getElementById('modalSede')).show();
}

function salvaSede() {
    const editId = document.getElementById('sede-edit-id').value;
    
    const payload = {
        tipo_sede: document.getElementById('sede-tipo').value,
        denominazione: document.getElementById('sede-denominazione').value,
        indirizzo: document.getElementById('sede-indirizzo').value,
        cap: document.getElementById('sede-cap').value,
        citta: document.getElementById('sede-citta').value,
        provincia: document.getElementById('sede-provincia').value,
        telefono: document.getElementById('sede-telefono').value,
        email: document.getElementById('sede-email').value,
        referente_id: document.getElementById('sede-referente').value || null,
        note: document.getElementById('sede-note').value,
        protetto: document.getElementById('sede-protetto').checked ? 1 : 0
    };
    
    if (!payload.indirizzo && !payload.citta) {
        alert('Inserire almeno indirizzo o citta');
        return;
    }
    
    let url, method;
    if (editId) {
        url = `/api/cliente/${clienteIdSedi}/sedi/${editId}`;
        method = 'PUT';
    } else {
        url = `/api/cliente/${clienteIdSedi}/sedi`;
        method = 'POST';
    }
    
    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('modalSede')).hide();
            caricaSedi();
        } else {
            alert(data.error || 'Errore salvataggio');
        }
    })
    .catch(err => {
        console.error(err);
        alert('Errore di rete');
    });
}

function confermaCancellaSede(id, nome) {
    if (confirm('Eliminare la sede "' + nome + '"?')) {
        eliminaSede(id);
    }
}

function eliminaSede(id) {
    fetch(`/api/cliente/${clienteIdSedi}/sedi/${id}`, {method: 'DELETE'})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                caricaSedi();
            } else {
                alert(data.error || 'Errore eliminazione');
            }
        });
}
</script>
