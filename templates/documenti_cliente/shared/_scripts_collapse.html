<!-- ==============================================================================
     SHARED - Scripts per Riquadri Collapse (Contratti, Quotazioni)
     ==============================================================================
     Versione: 1.0.0
     Data: 2025-01-20
     Descrizione: Funzioni JS per gestione riquadri con collapse
                  - caricaDocumenti(tipo): carica lista documenti
                  - renderDocumenti(): render lista con azioni
                  - setupUploadForm(): setup form upload
     Dipendenze: Richiede shared/_scripts_comuni.html (per getIcona, verificaDuplicati, etc.)
     ============================================================================== -->

<script>
(function() {
    // clienteId è già definito globalmente
    
    // === CARICA DOCUMENTI (Contratti, Quotazioni) ===
    window.caricaDocumenti = function(tipo) {
        const container = document.getElementById('lista-' + tipo);
        if (!container) return;
        
        fetch(`/api/cliente/${clienteId}/documenti/${tipo}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderDocumentiCollapse(container, data.documenti, tipo);
                } else {
                    container.innerHTML = '<div class="text-danger small">Errore</div>';
                }
            });
    };
    
    // === RENDER LISTA DOCUMENTI ===
    function renderDocumentiCollapse(container, documenti, tipo) {
        if (documenti.length === 0) {
            container.innerHTML = '<div class="text-muted small text-center py-2">Nessun documento</div>';
            return;
        }
        
        let html = '<ul class="list-unstyled mb-0 small">';
        documenti.forEach(doc => {
            html += `
                <li class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <a href="/cliente/${clienteId}/documento/${tipo}/${doc.nome}" 
                       target="_blank" class="text-truncate flex-grow-1 me-1">
                        ${getIcona(doc.nome)} ${doc.nome_originale}
                    </a>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-link btn-sm text-secondary p-0 px-1" 
                                onclick="apriRinomina('${tipo}', '${doc.nome}', '${doc.nome_originale}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-link btn-sm text-danger p-0 px-1" 
                                onclick="eliminaDocumento('${tipo}', '${doc.nome}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </li>
            `;
        });
        html += '</ul>';
        container.innerHTML = html;
    }
    
    // === SETUP FORM UPLOAD ===
    function setupUploadForm(tipo) {
        const form = document.getElementById('form-upload-' + tipo);
        if (!form) return;
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('file-' + tipo);
            if (!fileInput.files.length) {
                alert('Seleziona un file');
                return;
            }
            verificaDuplicati(tipo, fileInput.files[0], fileInput);
        });
    }
    
    // === INIT: Eventi collapse e form ===
    document.getElementById('collapseContratti')?.addEventListener('show.bs.collapse', () => caricaDocumenti('contratti'));
    document.getElementById('collapseOrdini')?.addEventListener('show.bs.collapse', () => caricaDocumenti('ordini'));
    document.getElementById('collapseQuotazioni')?.addEventListener('show.bs.collapse', () => caricaDocumenti('quotazioni'));
    
    setupUploadForm('contratti');
    setupUploadForm('quotazioni');
    setupUploadForm('ordini');
    
})();
</script>
