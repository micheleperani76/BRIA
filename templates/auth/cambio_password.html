{% extends "auth/_base_auth.html" %}

{% block title %}Cambio Password - Gestione Flotta{% endblock %}

{% block content %}
<!-- Steps indicator (solo se non volontario) -->
{% if not volontario %}
<div class="steps-indicator">
    <div class="step completed">
        <div class="step-number"><i class="bi bi-check"></i></div>
    </div>
    <div class="step active">
        <div class="step-line"></div>
        <div class="step-number">1</div>
    </div>
    <div class="step">
        <div class="step-line"></div>
        <div class="step-number">2</div>
    </div>
</div>
{% endif %}

<div class="auth-title">
    <h2>Cambio Password</h2>
    {% if volontario %}
    <p>Modifica la tua password di accesso</p>
    {% else %}
    <p>Per sicurezza, devi impostare una nuova password</p>
    {% endif %}
</div>

<form method="POST" action="{{ url_for('auth.cambio_password_volontario_submit') if volontario else url_for('auth.cambio_password_submit') }}" id="cambioPasswordForm">
    
    {% if volontario %}
    <!-- Password Attuale (solo per cambio volontario) -->
    <div class="mb-3">
        <label for="password_attuale" class="form-label">
            Password Attuale <span class="required-star">*</span>
        </label>
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-key"></i></span>
            <input type="password" 
                   class="form-control" 
                   id="password_attuale" 
                   name="password_attuale" 
                   placeholder="Inserisci password attuale"
                   required 
                   autofocus>
            <span class="input-group-text password-toggle" onclick="togglePassword('password_attuale', 'toggleIcon0')">
                <i class="bi bi-eye" id="toggleIcon0"></i>
            </span>
        </div>
    </div>
    <hr>
    {% endif %}
    
    <!-- Nuova Password -->
    <div class="mb-3">
        <label for="nuova_password" class="form-label">
            Nuova Password <span class="required-star">*</span>
        </label>
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-lock"></i></span>
            <input type="password" 
                   class="form-control" 
                   id="nuova_password" 
                   name="nuova_password" 
                   placeholder="Inserisci nuova password"
                   minlength="8"
                   required 
                   {% if not volontario %}autofocus{% endif %}>
            <span class="input-group-text password-toggle" onclick="togglePassword('nuova_password', 'toggleIcon1')">
                <i class="bi bi-eye" id="toggleIcon1"></i>
            </span>
        </div>
        <div class="form-text">
            Minimo 8 caratteri
        </div>
    </div>
    
    <!-- Conferma Password -->
    <div class="mb-4">
        <label for="conferma_password" class="form-label">
            Conferma Password <span class="required-star">*</span>
        </label>
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
            <input type="password" 
                   class="form-control" 
                   id="conferma_password" 
                   name="conferma_password" 
                   placeholder="Ripeti la password"
                   minlength="8"
                   required>
            <span class="input-group-text password-toggle" onclick="togglePassword('conferma_password', 'toggleIcon2')">
                <i class="bi bi-eye" id="toggleIcon2"></i>
            </span>
        </div>
        <div class="invalid-feedback" id="passwordMismatch" style="display: none;">
            Le password non corrispondono
        </div>
    </div>
    
    <!-- Pulsanti -->
    <div class="d-flex justify-content-between">
        {% if volontario %}
        <a href="{{ url_for('auth.profilo') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Annulla
        </a>
        {% else %}
        <div></div>
        {% endif %}
        <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="bi bi-check-circle me-2"></i>{% if volontario %}Cambia Password{% else %}Continua{% endif %}
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// Toggle password visibility
function togglePassword(inputId, iconId) {
    const passwordInput = document.getElementById(inputId);
    const toggleIcon = document.getElementById(iconId);
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.classList.remove('bi-eye');
        toggleIcon.classList.add('bi-eye-slash');
    } else {
        passwordInput.type = 'password';
        toggleIcon.classList.remove('bi-eye-slash');
        toggleIcon.classList.add('bi-eye');
    }
}

// Validate password match
const form = document.getElementById('cambioPasswordForm');
const nuovaPassword = document.getElementById('nuova_password');
const confermaPassword = document.getElementById('conferma_password');
const mismatchError = document.getElementById('passwordMismatch');

function checkPasswordMatch() {
    if (confermaPassword.value && nuovaPassword.value !== confermaPassword.value) {
        confermaPassword.classList.add('is-invalid');
        mismatchError.style.display = 'block';
        return false;
    } else {
        confermaPassword.classList.remove('is-invalid');
        mismatchError.style.display = 'none';
        return true;
    }
}

confermaPassword.addEventListener('input', checkPasswordMatch);
nuovaPassword.addEventListener('input', function() {
    if (confermaPassword.value) checkPasswordMatch();
});

form.addEventListener('submit', function(e) {
    if (!checkPasswordMatch()) {
        e.preventDefault();
        return;
    }
    
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvataggio...';
});
</script>
{% endblock %}
