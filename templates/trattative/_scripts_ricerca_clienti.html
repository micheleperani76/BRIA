<!-- ============================================================
     TRATTATIVE - Scripts Ricerca Clienti
     Versione: 1.0
     ============================================================ -->
<script>
// ==============================================================================
// RICERCA CLIENTI (MODAL NUOVA)
// ==============================================================================
function setupRicercaClienti() {
    const input = document.getElementById('nuovaClienteSearch');
    const dropdown = document.getElementById('nuovaClienteDropdown');
    
    if (!input || !dropdown || !window.clientiDisponibili) return;
    
    // Click: mostra tutti i clienti
    input.addEventListener('focus', function() {
        renderClientiDropdown(window.clientiDisponibili);
        dropdown.classList.add('show');
    });
    
    // Digitazione: filtra clienti
    input.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length === 0) {
            renderClientiDropdown(window.clientiDisponibili);
        } else {
            const filtrati = window.clientiDisponibili.filter(c => 
                c.nome.toLowerCase().includes(query) || 
                (c.piva && c.piva.toLowerCase().includes(query))
            );
            renderClientiDropdown(filtrati);
        }
        dropdown.classList.add('show');
    });
    
    // Chiudi dropdown quando si clicca fuori
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('show');
        }
    });
}

function renderClientiDropdown(clienti) {
    const dropdown = document.getElementById('nuovaClienteDropdown');
    if (!dropdown) return;
    
    if (clienti.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-item text-muted">Nessun cliente trovato</div>';
        return;
    }
    
    dropdown.innerHTML = clienti.map(c => 
        '<a class="dropdown-item" href="#" onclick="selezionaClienteNuova(' + c.id + ', \'' + escapeHtmlAttr(c.nome) + '\', \'' + (c.piva || '') + '\'); return false;">' +
        '<strong>' + escapeHtml(c.nome) + '</strong>' +
        (c.piva ? '<br><small class="text-muted">' + c.piva + '</small>' : '') +
        '</a>'
    ).join('');
}

function selezionaClienteNuova(id, nome, piva) {
    document.getElementById('nuovaClienteId').value = id;
    document.getElementById('nuovaClienteSearch').value = nome;
    document.getElementById('nuovaClienteDropdown').classList.remove('show');
    
    const sel = document.getElementById('nuovaClienteSelezionato');
    if (sel) {
        sel.querySelector('.nome-cliente').textContent = nome + (piva ? ' (' + piva + ')' : '');
        sel.classList.remove('d-none');
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeHtmlAttr(text) {
    if (!text) return '';
    return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}
</script>
