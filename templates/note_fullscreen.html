<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note - {{ cliente.nome_cliente or cliente.ragione_sociale }} - Gestione Flotta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        /* Layout principale */
        .notes-fullscreen {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar sinistra */
        .notes-sidebar {
            width: 220px;
            min-width: 220px;
            background: linear-gradient(180deg, #1e3a5f 0%, #152a45 100%);
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .sidebar-logo {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-close {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-close a {
            color: #ff6b6b;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .sidebar-close a:hover {
            color: #ff8787;
        }
        
        .sidebar-search {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-search input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            width: 100%;
            font-size: 0.85rem;
        }
        
        .sidebar-search input::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .sidebar-search input:focus {
            outline: none;
            border-color: rgba(255,255,255,0.4);
            background: rgba(255,255,255,0.15);
        }
        
        .sidebar-new-note {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .btn-new-note {
            width: 100%;
            background: #28a745;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-new-note:hover {
            background: #218838;
        }
        
        /* Lista note */
        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .note-list-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .note-list-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .note-list-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: #4dabf7;
        }
        
        .note-list-item.pinned {
            border-left-color: #ffc107;
            background: rgba(255,193,7,0.1);
        }
        
        .note-list-item.pinned.active {
            background: rgba(255,193,7,0.2);
        }
        
        .note-list-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .note-list-meta {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .note-list-item.pinned .note-list-title::before {
            content: "\1F4CC  ";
        }
        
        /* Area principale destra */
        .notes-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Header nota */
        .note-header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .note-title-section {
            flex: 1;
        }
        
        .note-title-input {
            font-size: 1.4rem;
            font-weight: 600;
            border: none;
            background: transparent;
            width: 100%;
            padding: 0;
        }
        
        .note-title-input:focus {
            outline: none;
        }
        
        .note-meta {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 4px;
        }
        
        .note-actions {
            display: flex;
            gap: 8px;
        }
        
        .note-actions .btn {
            padding: 6px 10px;
        }
        
        .btn-pin-note {
            color: #212529;
        }
        
        .btn-pin-note.active {
            background: #ffc107 !important;
            border-color: #ffc107 !important;
            color: #212529 !important;
        }
        
        /* Toolbar editor */
        .editor-toolbar {
            background: white;
            padding: 10px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toolbar-buttons {
            display: flex;
            gap: 5px;
        }
        
        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .toolbar-btn:hover {
            background: #e9ecef;
        }
        
        .toolbar-btn.active {
            background: #4472C4;
            color: white;
            border-color: #4472C4;
        }
        
        .save-status {
            font-size: 0.85rem;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .save-status.saved {
            color: #28a745;
        }
        
        .save-status.saving {
            color: #ffc107;
        }
        
        .save-status.unsaved {
            color: #dc3545;
        }
        
        /* Area editor */
        .editor-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .note-editor {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            min-height: 300px;
            height: calc(100% - 20px);
            padding: 20px;
            font-size: 1rem;
            line-height: 1.6;
            overflow-y: auto;
        }
        
        .note-editor:focus {
            outline: none;
            border-color: #4472C4;
            box-shadow: 0 0 0 3px rgba(68, 114, 196, 0.1);
        }
        
        /* Sezione allegati */
        .attachments-section {
            background: white;
            border-top: 1px solid #e5e7eb;
            max-height: 200px;
            transition: max-height 0.3s ease;
            overflow: hidden;
        }
        
        .attachments-section.collapsed {
            max-height: 45px;
        }
        
        .attachments-header {
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .attachments-header:hover {
            background: #e9ecef;
        }
        
        .attachments-header h6 {
            margin: 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .attachments-body {
            padding: 15px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            overflow-y: auto;
            max-height: 140px;
        }
        
        .attachment-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .attachment-item a {
            color: #495057;
            text-decoration: none;
        }
        
        .attachment-item a:hover {
            color: #4472C4;
        }
        
        .attachment-item .btn-delete-attachment {
            color: #dc3545;
            cursor: pointer;
            padding: 0;
            background: none;
            border: none;
        }
        
        /* Stato vuoto */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* Scrollbar personalizzata */
        .notes-list::-webkit-scrollbar,
        .note-editor::-webkit-scrollbar,
        .attachments-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .notes-list::-webkit-scrollbar-track,
        .note-editor::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .notes-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
        
        .note-editor::-webkit-scrollbar-thumb,
        .attachments-body::-webkit-scrollbar-thumb {
            background: #dee2e6;
            border-radius: 3px;
        }
        
        /* Responsive base per futuro mobile */
        @media (max-width: 768px) {
            .notes-sidebar {
                width: 100%;
                position: fixed;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .notes-sidebar.open {
                transform: translateX(0);
            }
            
            .notes-main {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="notes-fullscreen">
        <!-- Sidebar sinistra -->
        <div class="notes-sidebar" id="notesSidebar">
            <!-- Logo -->
            <div class="sidebar-logo" style="display: flex; align-items: center; gap: 10px;">
                <img src="https://www.brcarservice.it/wp-content/uploads/2025/08/logo-brcarservice-bianco-150x150.png" alt="Logo" style="width: 40px; height: 40px; border-radius: 50%;">
                <div style="font-size: 0.75rem; font-weight: 600; line-height: 1.2;">BR CAR SERVICE<br>GESTIONE FLOTTA</div>
            </div>
            
            <!-- Chiudi note -->
            <div class="sidebar-close">
                <a href="{{ url_cliente(cliente) or url_for('dettaglio_cliente', cliente_id=cliente.id) }}" id="btnChiudiNote">
                    <i class="bi bi-x-circle"></i> Chiudi note
                </a>
            </div>
            
            <!-- Cerca -->
            <div class="sidebar-search">
                <input type="text" id="searchNote" placeholder="Cerca note..." onkeyup="cercaNota()">
            </div>
            
            <!-- Nuova nota -->
            <div class="sidebar-new-note">
                <button class="btn-new-note" onclick="creaNuovaNota()">
                    <i class="bi bi-plus-lg"></i> Nuova nota
                </button>
            </div>
            
            <!-- Lista note -->
            <div class="notes-list" id="notesList">
                {% for nota in note_cliente %}
                <div class="note-list-item {% if nota.fissata %}pinned{% endif %} {% if nota.id == nota_attiva_id %}active{% endif %}" 
                     data-nota-id="{{ nota.id }}"
                     data-testo="{{ nota.testo|default('', true)|striptags|truncate(200)|lower }}"
                     onclick="apriNota({{ nota.id }})">
                    <div class="note-list-title">{{ nota.titolo or 'Senza titolo' }}</div>
                    <div class="note-list-meta">
                        <span><i class="bi bi-calendar"></i> {{ nota.data_creazione[:10] if nota.data_creazione else '-' }}</span>
                        {% if nota.autore %}
                        <span><i class="bi bi-person"></i> {{ nota.autore }}</span>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="text-center text-muted p-3" id="noNotesMsg">
                    <small>Nessuna nota presente</small>
                </div>
                {% endfor %}
            </div>
        
            <!-- Cestino note eliminate -->
            <div class="sidebar-trash" style="padding: 12px 15px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto;">
                <a href="#" onclick="mostraNoteEliminate(); return false;" style="color: #dc3545; text-decoration: none; display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                    <i class="bi bi-trash"></i> Cestino
                </a>
            </div>
        </div>
        
        <!-- Area principale -->
        <div class="notes-main" id="notesMain">
            {% if nota_attiva %}
            <!-- Header nota -->
            <div class="note-header">
                <div class="note-title-section">
                    <input type="text" class="note-title-input" id="notaTitolo" 
                           value="{{ nota_attiva.titolo or '' }}" 
                           placeholder="Titolo nota..."
                           onchange="segnaNonSalvato()">
                    <div class="note-meta">
                        <span><i class="bi bi-calendar"></i> {{ nota_attiva.data_creazione[:10] if nota_attiva.data_creazione else 'Nuova' }}</span>
                        <span class="ms-3">
                            <i class="bi bi-person"></i>
                            <span id="notaAutoreDisplay" class="badge bg-secondary">
                                {{ nota_attiva.autore if nota_attiva.autore else (session.cognome or session.username) }}
                            </span>
                        </span>
                        {% if nota_attiva.data_modifica %}
                        <span class="ms-3 text-warning"><i class="bi bi-pencil"></i> Modificata</span>
                        {% endif %}
                    </div>
                </div>
                <div class="note-actions">
                    <button class="btn btn-sm btn-outline-warning btn-pin-note {% if nota_attiva.fissata %}active{% endif %}" 
                            onclick="togglePinNota()" title="Fissa/Sfissa nota" id="btnPin">
                        <i class="bi bi-pin-fill"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="confermaEliminaNota()" title="Elimina nota">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            
            <!-- Toolbar editor -->
            <div class="editor-toolbar">
                <div class="toolbar-buttons">
                    <button class="toolbar-btn" onclick="formatBold()" title="Grassetto (Ctrl+B)" id="btnBold">
                        <i class="bi bi-type-bold"></i>
                    </button>
                    <button class="toolbar-btn" onclick="document.execCommand('undo')" title="Annulla (Ctrl+Z)">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                    <button class="toolbar-btn" onclick="salvaNota()" title="Salva (Ctrl+S)">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="save-status saved" id="saveStatus">
                    <i class="bi bi-check-circle"></i> Salvato
                </div>
            </div>
            
            <!-- Editor -->
            <div class="editor-container">
                <div class="note-editor" id="noteEditor" contenteditable="true" 
                     oninput="segnaNonSalvato()"
                     onkeydown="handleEditorKeydown(event)">{{ nota_attiva.testo|safe if nota_attiva.testo else '' }}</div>
            </div>
            
            <!-- Allegati -->
            <div class="attachments-section" id="attachmentsSection">
                <div class="attachments-header" onclick="toggleAllegati()">
                    <h6>
                        <i class="bi bi-paperclip"></i> 
                        Allegati 
                        <span class="badge bg-secondary" id="allegatiCount">{{ nota_attiva.allegati|length if nota_attiva.allegati else 0 }}</span>
                        <i class="bi bi-chevron-down ms-2" id="allegatiChevron"></i>
                    </h6>
                    <div>
                        <label class="btn btn-sm btn-outline-primary mb-0" onclick="event.stopPropagation()">
                            <i class="bi bi-upload"></i> Carica
                            <input type="file" multiple style="display: none;" onchange="caricaAllegati(this.files)" id="fileInput">
                        </label>
                    </div>
                </div>
                <div class="attachments-body" id="attachmentsBody">
                    {% if nota_attiva.allegati %}
                    {% for allegato in nota_attiva.allegati %}
                    <div class="attachment-item" id="allegato-{{ allegato.id }}">
                        <i class="bi bi-file-earmark"></i>
                        <a href="/allegato/cliente/{{ allegato.id }}" target="_blank">{{ allegato.nome_originale }}</a>
                        <button class="btn-delete-attachment" onclick="eliminaAllegato({{ allegato.id }})" title="Elimina">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-muted" id="noAllegatiMsg">Nessun allegato</div>
                    {% endif %}
                </div>
            </div>
            
            {% else %}
            <!-- Stato vuoto - nessuna nota selezionata -->
            <div class="empty-state">
                <i class="bi bi-journal-text"></i>
                <h5>Seleziona una nota</h5>
                <p class="text-muted">Scegli una nota dalla lista a sinistra o creane una nuova</p>
                <button class="btn btn-success mt-3" onclick="creaNuovaNota()">
                    <i class="bi bi-plus"></i> Nuova nota
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Form nascosto per upload allegati -->
    <form id="uploadForm" style="display: none;" enctype="multipart/form-data">
        <input type="file" id="hiddenFileInput" multiple>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variabili globali
        let notaCorrenteId = {{ nota_attiva.id if nota_attiva else 'null' }};
        let clienteId = {{ cliente.id }};
        let modificato = false;
        let salvaTimeout = null;
        let fissata = {{ 'true' if nota_attiva and nota_attiva.fissata else 'false' }};
        
        // Segna come non salvato
        function segnaNonSalvato() {
            modificato = true;
            document.getElementById('saveStatus').innerHTML = '<i class="bi bi-circle"></i> Non salvato';
            document.getElementById('saveStatus').className = 'save-status unsaved';
            
            // Salvataggio automatico dopo 3 secondi di inattivita
            clearTimeout(salvaTimeout);
            salvaTimeout = setTimeout(function() {
                if (modificato && notaCorrenteId) {
                    salvaNota();
                }
            }, 3000);
        }
        
        // Salva nota
        async function salvaNota() {
            if (!notaCorrenteId) return;
            
            const titolo = document.getElementById('notaTitolo').value;
            const testo = document.getElementById('noteEditor').innerHTML;
            
            document.getElementById('saveStatus').innerHTML = '<i class="bi bi-arrow-repeat"></i> Salvando...';
            document.getElementById('saveStatus').className = 'save-status saving';
            
            try {
                const response = await fetch('/api/cliente/' + clienteId + '/nota/' + notaCorrenteId + '/salva', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        titolo: titolo,
                        testo: testo,
                        fissata: fissata ? 1 : 0
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    modificato = false;
                    document.getElementById('saveStatus').innerHTML = '<i class="bi bi-check-circle"></i> Salvato';
                    document.getElementById('saveStatus').className = 'save-status saved';
                    
                    // Aggiorna titolo nella sidebar
                    const sidebarItem = document.querySelector('.note-list-item[data-nota-id="' + notaCorrenteId + '"] .note-list-title');
                    if (sidebarItem) {
                        sidebarItem.textContent = (fissata ? '{1F4CC} ' : '') + (titolo || 'Senza titolo');
                    }
                } else {
                    throw new Error(data.error || 'Errore sconosciuto');
                }
            } catch (error) {
                console.error('Errore salvataggio:', error);
                document.getElementById('saveStatus').innerHTML = '<i class="bi bi-exclamation-triangle"></i> Errore!';
                document.getElementById('saveStatus').className = 'save-status unsaved';
            }
        }
        
        // Apri nota
        async function apriNota(notaId) {
            if (notaId === notaCorrenteId) return;
            
            // Salva nota corrente se modificata
            if (modificato && notaCorrenteId) {
                await salvaNota();
            }
            
            // Naviga alla nuova nota
            window.location.href = '/cliente/' + clienteId + '/note?nota=' + notaId;
        }
        
        // Crea nuova nota
        async function creaNuovaNota() {
            // Salva nota corrente se modificata
            if (modificato && notaCorrenteId) {
                await salvaNota();
            }
            
            try {
                const response = await fetch('/api/cliente/' + clienteId + '/nota/nuova', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        titolo: 'Nuova nota',
                        testo: ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.nota_id) {
                    window.location.href = '/cliente/' + clienteId + '/note?nota=' + data.nota_id;
                } else {
                    alert('Errore nella creazione della nota');
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore nella creazione della nota');
            }
        }
        
        // Toggle pin nota
        async function togglePinNota() {
            fissata = !fissata;
            
            const btnPin = document.getElementById('btnPin');
            if (fissata) {
                btnPin.classList.add('active');
            } else {
                btnPin.classList.remove('active');
            }
            
            // Aggiorna sidebar
            const sidebarItem = document.querySelector('.note-list-item[data-nota-id="' + notaCorrenteId + '"]');
            if (sidebarItem) {
                if (fissata) {
                    sidebarItem.classList.add('pinned');
                } else {
                    sidebarItem.classList.remove('pinned');
                }
            }
            
            segnaNonSalvato();
        }
        
        // Conferma elimina nota
        function confermaEliminaNota() {
            if (confirm('Sei sicuro di voler eliminare questa nota?')) {
                eliminaNota();
            }
        }
        
        // Elimina nota (soft delete)
        async function eliminaNota() {
            try {
                const response = await fetch('/api/cliente/' + clienteId + '/nota/' + notaCorrenteId + '/elimina', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = '/cliente/' + clienteId + '/note';
                } else {
                    alert('Errore eliminazione: ' + (data.error || 'sconosciuto'));
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore eliminazione nota');
            }
        }
        
        // Cerca nota - cerca in titolo E corpo
        function cercaNota() {
            const query = document.getElementById('searchNote').value.toLowerCase();
            const items = document.querySelectorAll('.note-list-item');
            
            items.forEach(function(item) {
                const title = item.querySelector('.note-list-title').textContent.toLowerCase();
                const testo = item.getAttribute('data-testo') || '';
                
                if (title.includes(query) || testo.includes(query)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Toggle allegati
        function toggleAllegati() {
            const section = document.getElementById('attachmentsSection');
            const chevron = document.getElementById('allegatiChevron');
            
            section.classList.toggle('collapsed');
            
            if (section.classList.contains('collapsed')) {
                chevron.classList.remove('bi-chevron-down');
                chevron.classList.add('bi-chevron-up');
            } else {
                chevron.classList.remove('bi-chevron-up');
                chevron.classList.add('bi-chevron-down');
            }
        }
        
        // Carica allegati
        async function caricaAllegati(files) {
            if (!files.length || !notaCorrenteId) return;
            
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('allegati', files[i]);
            }
            
            try {
                const response = await fetch('/api/cliente/' + clienteId + '/nota/' + notaCorrenteId + '/allegato', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Ricarica pagina per vedere i nuovi allegati
                    window.location.reload();
                } else {
                    alert('Errore upload: ' + (data.error || 'sconosciuto'));
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore upload allegati');
            }
        }
        
        // Elimina allegato
        async function eliminaAllegato(allegatoId) {
            if (!confirm('Eliminare questo allegato?')) return;
            
            try {
                const response = await fetch('/api/allegato/' + allegatoId + '/elimina', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('allegato-' + allegatoId).remove();
                    
                    // Aggiorna conteggio
                    const countEl = document.getElementById('allegatiCount');
                    countEl.textContent = parseInt(countEl.textContent) - 1;
                } else {
                    alert('Errore eliminazione: ' + (data.error || 'sconosciuto'));
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore eliminazione allegato');
            }
        }
        
        // Format bold
        function formatBold() {
            document.execCommand('bold', false, null);
            document.getElementById('noteEditor').focus();
        }
        
        // Handle editor keydown
        function handleEditorKeydown(event) {
            // Ctrl+S = Salva
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
                salvaNota();
            }
            // Ctrl+B = Bold
            if (event.ctrlKey && event.key === 'b') {
                event.preventDefault();
                formatBold();
            }
        }
        
        // Mostra note eliminate (cestino)
        async function mostraNoteEliminate() {
            try {
                const response = await fetch('/api/cliente/' + clienteId + '/note/eliminate');
                const data = await response.json();
                
                if (data.success && data.note.length > 0) {
                    let html = '<div class="p-4"><h5 class="mb-3"><i class="bi bi-trash text-danger"></i> Cestino</h5><hr>';
                    data.note.forEach(function(n) {
                        html += '<div class="d-flex justify-content-between align-items-center mb-2 p-3 bg-light rounded">';
                        html += '<div><strong>' + n.titolo + '</strong><br><small class="text-muted">Eliminata: ' + (n.data_eliminazione || '-') + '</small></div>';
                        html += '<div>';
                        html += '<button class="btn btn-sm btn-success me-1" onclick="ripristinaNota(' + n.id + ')" title="Ripristina"><i class="bi bi-arrow-counterclockwise"></i></button>';
                        html += '<button class="btn btn-sm btn-danger" onclick="eliminaDefinitivamente(' + n.id + ')" title="Elimina definitivamente"><i class="bi bi-trash"></i></button>';
                        html += '</div></div>';
                    });
                    html += '<hr><p class="text-muted small">Clicca su una nota nella lista per tornare alle note attive.</p></div>';
                    
                    document.getElementById('noteEditor').innerHTML = html;
                    document.getElementById('notaTitolo').value = 'Cestino';
                    notaCorrenteId = null;
                } else {
                    alert('Nessuna nota nel cestino');
                }
            } catch(e) { 
                console.error(e); 
                alert('Errore caricamento cestino'); 
            }
        }
        
        // Ripristina nota dal cestino
        async function ripristinaNota(notaId) {
            if (!confirm('Ripristinare questa nota?')) return;
            try {
                const response = await fetch('/api/nota/' + notaId + '/ripristina', {method: 'POST'});
                const data = await response.json();
                if (data.success) { 
                    window.location.reload(); 
                } else { 
                    alert('Errore: ' + data.error); 
                }
            } catch(e) { 
                alert('Errore ripristino'); 
            }
        }
        
        // Elimina nota definitivamente
        async function eliminaDefinitivamente(notaId) {
            if (!confirm('Eliminare DEFINITIVAMENTE questa nota? Non potra essere recuperata!')) return;
            try {
                const response = await fetch('/api/nota/' + notaId + '/elimina-definitivo', {method: 'POST'});
                const data = await response.json();
                if (data.success) { 
                    mostraNoteEliminate(); 
                } else { 
                    alert('Errore: ' + data.error); 
                }
            } catch(e) { 
                alert('Errore eliminazione'); 
            }
        }
        
        // Salva prima di uscire
        window.addEventListener('beforeunload', function(e) {
            if (modificato) {
                salvaNota();
            }
        });
        
        // Intercetta click su chiudi note per salvare prima
        document.addEventListener('DOMContentLoaded', function() {
            const btnChiudi = document.getElementById('btnChiudiNote');
            if (btnChiudi) {
                btnChiudi.addEventListener('click', async function(e) {
                    if (modificato) {
                        e.preventDefault();
                        await salvaNota();
                        window.location.href = this.href;
                    }
                });
            }
            
            // Focus sull'editor al caricamento
            const editor = document.getElementById('noteEditor');
            if (editor) {
                editor.focus();
            }
        });
    </script>
</body>
</html>
