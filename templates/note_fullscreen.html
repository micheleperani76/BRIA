<!DOCTYPE html>
{# ==============================================================================
   NOTE FULLSCREEN - Motore Note Cliente
   ==============================================================================
   Versione: 3.0.0
   Data: 2026-02-12
   Descrizione: Sistema note ispirato a Evernote, riadattato per gestione_flotta.
                Ogni scheda cliente = 1 taccuino. Sidebar + Editor + Cestino.
   
   API utilizzate (Blueprint note_clienti):
     /api/note-clienti/<cid>/lista          GET   Note attive
     /api/note-clienti/<cid>/crea           POST  Crea nota
     /api/note-clienti/<cid>/<nid>/modifica POST  Modifica nota
     /api/note-clienti/<cid>/<nid>/elimina  POST  Soft delete
     /api/note-clienti/<cid>/<nid>/fissa    POST  Toggle pin
     /api/note-clienti/<cid>/cestino        GET   Note eliminate
     /api/note-clienti/<cid>/<nid>/ripristina       POST  Ripristina
     /api/note-clienti/<cid>/<nid>/elimina-definitivo POST  Elimina per sempre
     /api/note-clienti/<cid>/<nid>/allegati POST  Upload allegati
     /api/note-clienti/allegato/<aid>/elimina  POST  Elimina allegato
     /api/note-clienti/allegato/<aid>/scarica  GET   Download allegato
     /cliente/<cid>/note/cerca?q=           GET   Ricerca full-text
   ============================================================================== #}
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Note - {{ cliente.nome_cliente }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
    /* ==========================================================================
       LAYOUT PRINCIPALE
       ========================================================================== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        height: 100vh;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f5f5f5;
    }
    
    .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    
    /* ==========================================================================
       TOP BAR - Ricerca full-text + info cliente
       ========================================================================== */
    .top-bar {
        display: flex;
        align-items: center;
        padding: 8px 16px;
        background: #2c3e50;
        color: white;
        gap: 16px;
        flex-shrink: 0;
        z-index: 10;
    }
    
    .top-bar .client-name {
        font-weight: 600;
        font-size: 0.95rem;
        white-space: nowrap;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .top-bar .search-box {
        flex: 1;
        max-width: 500px;
        margin: 0 auto;
        position: relative;
    }
    
    .top-bar .search-box input {
        width: 100%;
        padding: 6px 12px 6px 36px;
        border: none;
        border-radius: 20px;
        background: rgba(255,255,255,0.15);
        color: white;
        font-size: 0.9rem;
        outline: none;
        transition: background 0.2s;
    }
    
    .top-bar .search-box input::placeholder { color: rgba(255,255,255,0.5); }
    .top-bar .search-box input:focus { background: rgba(255,255,255,0.25); }
    
    .top-bar .search-box .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255,255,255,0.5);
        font-size: 0.85rem;
    }
    
    .top-bar .search-box .search-clear {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: rgba(255,255,255,0.5);
        cursor: pointer;
        display: none;
        font-size: 0.8rem;
    }
    
    .top-bar .search-box .search-clear.visible { display: block; }
    
    .top-bar .btn-close-page {
        background: none;
        border: none;
        color: white;
        font-size: 1.1rem;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background 0.2s;
        text-decoration: none;
    }
    
    .top-bar .btn-close-page:hover { background: rgba(255,255,255,0.1); color: white; }
    
    /* ==========================================================================
       CONTENT AREA - Sidebar + Editor
       ========================================================================== */
    .content-area {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    
    /* ==========================================================================
       SIDEBAR - Lista note / Cestino
       ========================================================================== */
    .sidebar {
        width: 300px;
        min-width: 300px;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .sidebar-header {
        padding: 12px 16px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }
    
    .sidebar-header .view-label {
        font-weight: 600;
        font-size: 0.9rem;
        color: #333;
    }
    
    .sidebar-header .note-count {
        background: #6c757d;
        color: white;
        border-radius: 12px;
        padding: 1px 8px;
        font-size: 0.75rem;
        margin-left: 6px;
    }
    
    .sidebar-actions {
        display: flex;
        gap: 4px;
    }
    
    .sidebar-actions button {
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 4px 6px;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: all 0.15s;
    }
    
    .sidebar-actions button:hover { background: #e9ecef; color: #333; }
    .sidebar-actions button.active { color: #dc3545; background: #f8d7da; }
    
    .note-list {
        flex: 1;
        overflow-y: auto;
        padding: 4px 0;
    }
    
    .note-list-item {
        padding: 10px 16px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background 0.1s;
        position: relative;
    }
    
    .note-list-item:hover { background: #e9ecef; }
    .note-list-item.selected { background: #d4edfa; border-left: 3px solid #0d6efd; }
    .note-list-item.pinned { border-left: 3px solid #ffc107; }
    .note-list-item.selected.pinned { border-left: 3px solid #0d6efd; }
    
    .note-list-item .note-title {
        font-weight: 600;
        font-size: 0.85rem;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .note-list-item .note-preview {
        font-size: 0.8rem;
        color: #888;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 2px;
    }
    
    .note-list-item .note-meta {
        font-size: 0.72rem;
        color: #aaa;
        margin-top: 3px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .note-list-item .pin-indicator {
        color: #ffc107;
        font-size: 0.7rem;
    }
    
    .note-list-empty {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }
    
    .note-list-empty i { font-size: 2.5rem; display: block; margin-bottom: 12px; }
    
    /* ==========================================================================
       EDITOR
       ========================================================================== */
    .editor-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: white;
    }
    
    .editor-toolbar {
        padding: 8px 16px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }
    
    .editor-toolbar .title-input {
        border: none;
        font-size: 1.1rem;
        font-weight: 600;
        flex: 1;
        outline: none;
        padding: 4px 0;
        color: #333;
    }
    
    .editor-toolbar .title-input::placeholder { color: #ccc; }
    
    .editor-toolbar .toolbar-actions {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .editor-toolbar .toolbar-actions button {
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: all 0.15s;
    }
    
    .editor-toolbar .toolbar-actions button:hover { background: #f0f0f0; color: #333; }
    .editor-toolbar .toolbar-actions button.pin-active { color: #ffc107; }
    
    .save-indicator {
        font-size: 0.75rem;
        color: #999;
        margin-right: 8px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .save-indicator.saving { color: #ffc107; }
    .save-indicator.saved { color: #28a745; }
    .save-indicator.error { color: #dc3545; }
    
    .editor-meta {
        padding: 4px 16px;
        font-size: 0.75rem;
        color: #999;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        gap: 16px;
        flex-shrink: 0;
    }
    
    .editor-content {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
    }
    
    .editor-content .note-textarea {
        width: 100%;
        height: 100%;
        border: none;
        outline: none;
        resize: none;
        font-size: 0.9rem;
        line-height: 1.6;
        color: #333;
        font-family: inherit;
    }
    
    .editor-content .note-textarea::placeholder { color: #ccc; }
    
    /* Allegati */
    .editor-attachments {
        padding: 8px 16px;
        border-top: 1px solid #eee;
        flex-shrink: 0;
        max-height: 120px;
        overflow-y: auto;
    }
    
    .attachment-item {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #f0f0f0;
        border-radius: 4px;
        padding: 3px 8px;
        margin: 2px 4px 2px 0;
        font-size: 0.78rem;
        color: #555;
    }
    
    .attachment-item a { color: #0d6efd; text-decoration: none; }
    .attachment-item a:hover { text-decoration: underline; }
    .attachment-item .btn-remove-att {
        background: none; border: none; color: #dc3545;
        cursor: pointer; padding: 0 2px; font-size: 0.85rem;
    }
    
    /* Editor vuoto / placeholder */
    .editor-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #bbb;
    }
    
    .editor-placeholder i { font-size: 3rem; margin-bottom: 16px; }
    
    /* ==========================================================================
       AZIONI CESTINO (nel toolbar quando si visualizza una nota cestinata)
       ========================================================================== */
    .trash-actions {
        display: flex;
        gap: 8px;
        padding: 8px 16px;
        background: #fff3cd;
        border-bottom: 1px solid #ffc107;
        flex-shrink: 0;
    }
    
    .trash-actions .badge-trash {
        background: #ffc107;
        color: #333;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
        flex: 1;
    }
    
    /* ==========================================================================
       RICERCA HIGHLIGHT
       ========================================================================== */
    mark { background: #fff3cd; padding: 0 2px; border-radius: 2px; }
    
    /* ==========================================================================
       TOAST NOTIFICHE (al posto degli alert)
       ========================================================================== */
    .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
    }
    
    .note-toast {
        padding: 10px 16px;
        border-radius: 8px;
        color: white;
        font-size: 0.85rem;
        margin-top: 8px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        animation: fadeInUp 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .note-toast.success { background: #28a745; }
    .note-toast.error { background: #dc3545; }
    .note-toast.info { background: #17a2b8; }
    
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    </style>
</head>
<body>
<div class="app-container">
    
    <!-- ================================================================
         TOP BAR
         ================================================================ -->
    <div class="top-bar">
        <span class="client-name">
            <i class="bi bi-journal-text me-1"></i>
            {{ cliente.nome_cliente }}
        </span>
        
        <div class="search-box">
            <i class="bi bi-search search-icon"></i>
            <input type="text" id="searchInput" placeholder="Cerca nelle note..." 
                   oninput="onSearchInput()" autocomplete="off">
            <button class="search-clear" id="searchClear" onclick="clearSearch()">
                <i class="bi bi-x-circle-fill"></i>
            </button>
        </div>
        
        <a href="#" class="btn-close-page" onclick="window.close(); return false;" title="Torna alla scheda cliente">
            <i class="bi bi-x-lg"></i>
        </a>
    </div>
    
    <!-- ================================================================
         CONTENT: SIDEBAR + EDITOR
         ================================================================ -->
    <div class="content-area">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div>
                    <span class="view-label" id="viewLabel">Note</span>
                    <span class="note-count" id="noteCount">0</span>
                </div>
                <div class="sidebar-actions">
                    <button onclick="creaNota()" title="Nuova nota" id="btnNuovaNota">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                    <button onclick="toggleCestino()" title="Cestino" id="btnCestino">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <div class="note-list" id="noteList">
                <!-- Popolato via JS -->
            </div>
        </div>
        
        <!-- EDITOR -->
        <div class="editor-area" id="editorArea">
            <!-- Placeholder iniziale -->
            <div class="editor-placeholder" id="editorPlaceholder">
                <i class="bi bi-journal-text"></i>
                <p>Seleziona una nota o creane una nuova</p>
            </div>
            
            <!-- Editor attivo (nascosto inizialmente) -->
            <div id="editorActive" style="display:none; flex-direction:column; height:100%;">
                
                <!-- Barra avviso cestino (visibile solo per note cestinate) -->
                <div class="trash-actions" id="trashBar" style="display:none;">
                    <span class="badge-trash">
                        <i class="bi bi-trash"></i> Nota nel cestino
                    </span>
                    <button class="btn btn-success btn-sm" onclick="ripristinaNota()">
                        <i class="bi bi-arrow-counterclockwise"></i> Ripristina
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="eliminaDefinitivo()">
                        <i class="bi bi-trash"></i> Elimina per sempre
                    </button>
                </div>
                
                <!-- Toolbar -->
                <div class="editor-toolbar">
                    <input type="text" class="title-input" id="editorTitle" 
                           placeholder="Titolo nota..." oninput="onEditorChange()">
                    <div class="toolbar-actions">
                        <span class="save-indicator saved" id="saveIndicator">
                            <i class="bi bi-check-circle"></i> Salvato
                        </span>
                        <button onclick="togglePin()" title="Fissa/Sfissa" id="btnPin">
                            <i class="bi bi-pin"></i>
                        </button>
                        <button onclick="uploadAllegato()" title="Allega file">
                            <i class="bi bi-paperclip"></i>
                        </button>
                        <button onclick="eliminaNota()" title="Elimina nota" id="btnElimina">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Meta -->
                <div class="editor-meta" id="editorMeta"></div>
                
                <!-- Contenuto -->
                <div class="editor-content">
                    <textarea class="note-textarea" id="editorText" 
                              placeholder="Scrivi qui..." oninput="onEditorChange()"></textarea>
                </div>
                
                <!-- Allegati -->
                <div class="editor-attachments" id="editorAttachments" style="display:none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Input file nascosto per upload allegati -->
<input type="file" id="fileInput" multiple style="display:none" onchange="onFileSelected()">

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ==========================================================================
   STATO APPLICAZIONE
   ========================================================================== */
const CLIENT_ID = {{ cliente.id }};
const API_BASE = '/api/note-clienti/' + CLIENT_ID;

let state = {
    view: 'note',          // 'note' | 'cestino' | 'ricerca'
    notes: [],             // note attive caricate
    trashNotes: [],        // note cestino caricate  
    selectedId: null,      // ID nota selezionata
    isPinned: false,       // nota corrente fissata
    isDirty: false,        // modifiche non salvate
    isTrashView: false,    // stiamo guardando il cestino
    searchQuery: '',       // query ricerca attiva
    saveTimeout: null      // timer autosave
};

/* ==========================================================================
   INIZIALIZZAZIONE
   ========================================================================== */
document.addEventListener('DOMContentLoaded', function() {
    caricaNote();
    
    // Ctrl+S per salvare
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            salvaNota();
        }
    });
});

/* ==========================================================================
   CARICAMENTO DATI
   ========================================================================== */
async function caricaNote() {
    try {
        const resp = await fetch(API_BASE + '/lista');
        const data = await resp.json();
        
        if (data.success) {
            state.notes = data.note;
            state.isTrashView = false;
            state.view = 'note';
            renderSidebar();
            
            // Seleziona prima nota o mostra placeholder
            if (state.notes.length > 0) {
                selezionaNota(state.notes[0].id);
            } else {
                mostraPlaceholder();
            }
        } else {
            toast('Errore caricamento note', 'error');
        }
    } catch (e) {
        console.error('Errore caricaNote:', e);
        toast('Errore di connessione', 'error');
    }
}

async function caricaCestino() {
    try {
        const resp = await fetch(API_BASE + '/cestino');
        const data = await resp.json();
        
        if (data.success) {
            state.trashNotes = data.note;
            state.isTrashView = true;
            state.view = 'cestino';
            renderSidebar();
            
            if (state.trashNotes.length > 0) {
                selezionaNota(state.trashNotes[0].id);
            } else {
                mostraPlaceholder();
            }
        } else {
            toast('Errore caricamento cestino', 'error');
        }
    } catch (e) {
        console.error('Errore caricaCestino:', e);
        toast('Errore di connessione', 'error');
    }
}

async function cercaNote(query) {
    try {
        const resp = await fetch('/cliente/' + CLIENT_ID + '/note/cerca?q=' + encodeURIComponent(query));
        const data = await resp.json();
        
        state.notes = data.note || [];
        state.view = 'ricerca';
        state.isTrashView = false;
        renderSidebar();
        
        if (state.notes.length > 0) {
            selezionaNota(state.notes[0].id);
        } else {
            mostraPlaceholder();
        }
    } catch (e) {
        console.error('Errore cercaNote:', e);
        toast('Errore ricerca', 'error');
    }
}

/* ==========================================================================
   RENDERING SIDEBAR
   ========================================================================== */
function renderSidebar() {
    const list = document.getElementById('noteList');
    const label = document.getElementById('viewLabel');
    const count = document.getElementById('noteCount');
    const btnNuova = document.getElementById('btnNuovaNota');
    const btnCest = document.getElementById('btnCestino');
    
    let notes = state.isTrashView ? state.trashNotes : state.notes;
    
    // Aggiorna header
    if (state.isTrashView) {
        label.textContent = 'Cestino';
        btnCest.classList.add('active');
        btnNuova.style.display = 'none';
    } else if (state.view === 'ricerca') {
        label.textContent = 'Ricerca';
        btnCest.classList.remove('active');
        btnNuova.style.display = '';
    } else {
        label.textContent = 'Note';
        btnCest.classList.remove('active');
        btnNuova.style.display = '';
    }
    
    count.textContent = notes.length;
    
    // Lista vuota
    if (notes.length === 0) {
        if (state.isTrashView) {
            list.innerHTML = '<div class="note-list-empty"><i class="bi bi-trash"></i><p>Cestino vuoto</p></div>';
        } else if (state.view === 'ricerca') {
            list.innerHTML = '<div class="note-list-empty"><i class="bi bi-search"></i><p>Nessun risultato</p></div>';
        } else {
            list.innerHTML = '<div class="note-list-empty"><i class="bi bi-journal-plus"></i><p>Nessuna nota<br><small>Crea la prima nota con il pulsante +</small></p></div>';
        }
        return;
    }
    
    // Render lista
    let html = '';
    notes.forEach(function(n) {
        const selected = (n.id === state.selectedId) ? ' selected' : '';
        const pinned = (n.fissata && !state.isTrashView) ? ' pinned' : '';
        const preview = stripHtml(n.testo || '').substring(0, 80);
        const data = formatData(state.isTrashView ? n.data_eliminazione : n.data_creazione);
        const allegatiCount = (n.allegati && n.allegati.length > 0) ? 
            ' <i class="bi bi-paperclip" title="' + n.allegati.length + ' allegat' + (n.allegati.length === 1 ? 'o' : 'i') + '"></i>' : '';
        
        html += '<div class="note-list-item' + selected + pinned + '" data-id="' + n.id + '" onclick="onClickNota(' + n.id + ')">';
        html += '<div class="note-title">';
        if (n.fissata && !state.isTrashView) html += '<span class="pin-indicator"><i class="bi bi-pin-fill"></i></span> ';
        html += escapeHtml(n.titolo || 'Senza titolo');
        html += '</div>';
        if (preview) html += '<div class="note-preview">' + escapeHtml(preview) + '</div>';
        html += '<div class="note-meta"><span>' + data + '</span>';
        if (n.autore) html += '<span>' + escapeHtml(n.autore) + '</span>';
        html += allegatiCount + '</div>';
        html += '</div>';
    });
    
    list.innerHTML = html;
}

/* ==========================================================================
   SELEZIONE NOTA
   ========================================================================== */
async function selezionaNota(id) {
    // Salva nota precedente se modificata
    if (state.isDirty && state.selectedId && !state.isTrashView) {
        await salvaNota();
    }
    
    state.selectedId = id;
    
    // Trova la nota
    const notes = state.isTrashView ? state.trashNotes : state.notes;
    const nota = notes.find(function(n) { return n.id === id; });
    
    if (!nota) {
        mostraPlaceholder();
        return;
    }
    
    // Aggiorna selezione sidebar
    document.querySelectorAll('.note-list-item').forEach(function(el) {
        el.classList.toggle('selected', parseInt(el.dataset.id) === id);
    });
    
    // Mostra editor
    document.getElementById('editorPlaceholder').style.display = 'none';
    document.getElementById('editorActive').style.display = 'flex';
    
    // Popola editor
    document.getElementById('editorTitle').value = nota.titolo || '';
    document.getElementById('editorText').value = stripHtml(nota.testo || '');
    
    // Pin state
    state.isPinned = nota.fissata ? true : false;
    aggiornaIconaPin();
    
    // Meta
    let meta = '';
    if (nota.data_creazione) meta += '<span><i class="bi bi-calendar"></i> ' + formatData(nota.data_creazione) + '</span>';
    if (nota.autore) meta += '<span><i class="bi bi-person"></i> ' + escapeHtml(nota.autore) + '</span>';
    if (nota.data_modifica) meta += '<span><i class="bi bi-pencil text-warning"></i> Modificata ' + formatData(nota.data_modifica) + '</span>';
    document.getElementById('editorMeta').innerHTML = meta;
    
    // Barra cestino
    document.getElementById('trashBar').style.display = state.isTrashView ? 'flex' : 'none';
    
    // Editor readonly se cestino
    document.getElementById('editorTitle').readOnly = state.isTrashView;
    document.getElementById('editorText').readOnly = state.isTrashView;
    document.getElementById('btnPin').style.display = state.isTrashView ? 'none' : '';
    document.getElementById('btnElimina').style.display = state.isTrashView ? 'none' : '';
    
    // Allegati
    renderAllegati(nota.allegati || []);
    
    // Reset stato
    state.isDirty = false;
    aggiornaIndicatoreSalvataggio('saved');
}

function mostraPlaceholder() {
    state.selectedId = null;
    document.getElementById('editorPlaceholder').style.display = 'flex';
    document.getElementById('editorActive').style.display = 'none';
    
    // Aggiorna placeholder in base alla vista
    const ph = document.getElementById('editorPlaceholder');
    if (state.isTrashView) {
        ph.innerHTML = '<i class="bi bi-trash"></i><p>Cestino vuoto</p><small style="color:#ccc">Nessuna nota eliminata</small>';
    } else if (state.view === 'ricerca') {
        ph.innerHTML = '<i class="bi bi-search"></i><p>Nessun risultato</p>';
    } else {
        ph.innerHTML = '<i class="bi bi-journal-text"></i><p>Seleziona una nota o creane una nuova</p>';
    }
}

/* ==========================================================================
   OPERAZIONI CRUD
   ========================================================================== */
async function creaNota() {
    if (state.isTrashView) {
        toggleCestino();
        return;
    }
    
    // Salva nota corrente se modificata
    if (state.isDirty && state.selectedId) {
        await salvaNota();
    }
    
    try {
        const resp = await fetch(API_BASE + '/crea', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ titolo: 'Nuova nota', testo: '' })
        });
        const data = await resp.json();
        
        if (data.success) {
            await caricaNote();
            selezionaNota(data.nota_id);
            // Focus sul titolo per modifica immediata
            const titleInput = document.getElementById('editorTitle');
            titleInput.focus();
            titleInput.select();
            toast('Nota creata', 'success');
        } else {
            toast('Errore creazione: ' + (data.error || ''), 'error');
        }
    } catch (e) {
        console.error('Errore creaNota:', e);
        toast('Errore di connessione', 'error');
    }
}

async function salvaNota() {
    if (!state.selectedId || state.isTrashView) return;
    
    clearTimeout(state.saveTimeout);
    aggiornaIndicatoreSalvataggio('saving');
    
    const titolo = document.getElementById('editorTitle').value.trim();
    const testo = document.getElementById('editorText').value;
    
    if (!titolo) {
        aggiornaIndicatoreSalvataggio('error');
        return;
    }
    
    try {
        const resp = await fetch(API_BASE + '/' + state.selectedId + '/modifica', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                titolo: titolo, 
                testo: testo,
                fissata: state.isPinned ? 1 : 0
            })
        });
        const data = await resp.json();
        
        if (data.success) {
            state.isDirty = false;
            aggiornaIndicatoreSalvataggio('saved');
            
            // Aggiorna titolo in sidebar
            const item = document.querySelector('.note-list-item[data-id="' + state.selectedId + '"] .note-title');
            if (item) {
                const pinHtml = state.isPinned ? '<span class="pin-indicator"><i class="bi bi-pin-fill"></i></span> ' : '';
                item.innerHTML = pinHtml + escapeHtml(titolo);
            }
            
            // Aggiorna preview in sidebar
            const preview = document.querySelector('.note-list-item[data-id="' + state.selectedId + '"] .note-preview');
            if (preview) {
                preview.textContent = stripHtml(testo).substring(0, 80);
            }
            
            // Aggiorna cache locale
            const nota = state.notes.find(function(n) { return n.id === state.selectedId; });
            if (nota) {
                nota.titolo = titolo;
                nota.testo = testo;
                nota.fissata = state.isPinned ? 1 : 0;
            }
        } else {
            aggiornaIndicatoreSalvataggio('error');
            toast('Errore salvataggio: ' + (data.error || ''), 'error');
        }
    } catch (e) {
        console.error('Errore salvaNota:', e);
        aggiornaIndicatoreSalvataggio('error');
        toast('Errore di connessione', 'error');
    }
}

async function eliminaNota() {
    if (!state.selectedId || state.isTrashView) return;
    
    const nota = state.notes.find(function(n) { return n.id === state.selectedId; });
    if (!nota) return;
    
    if (!confirm('Eliminare "' + (nota.titolo || 'Senza titolo') + '"?\nLa nota finir&agrave; nel cestino.')) return;
    
    try {
        const resp = await fetch(API_BASE + '/' + state.selectedId + '/elimina', {
            method: 'POST'
        });
        const data = await resp.json();
        
        if (data.success) {
            toast('Nota spostata nel cestino', 'info');
            await caricaNote();
        } else {
            toast('Errore: ' + (data.error || ''), 'error');
        }
    } catch (e) {
        toast('Errore di connessione', 'error');
    }
}

async function togglePin() {
    if (!state.selectedId || state.isTrashView) return;
    
    try {
        const resp = await fetch(API_BASE + '/' + state.selectedId + '/fissa', {
            method: 'POST'
        });
        const data = await resp.json();
        
        if (data.success) {
            state.isPinned = data.fissata ? true : false;
            aggiornaIconaPin();
            
            // Aggiorna cache e sidebar
            const nota = state.notes.find(function(n) { return n.id === state.selectedId; });
            if (nota) nota.fissata = data.fissata;
            
            // Ricarica per riordinare (fissate in alto)
            await caricaNote();
            selezionaNota(state.selectedId);
        }
    } catch (e) {
        toast('Errore', 'error');
    }
}

/* ==========================================================================
   CESTINO
   ========================================================================== */
function toggleCestino() {
    if (state.isTrashView) {
        // Torna alle note
        caricaNote();
    } else {
        // Salva e apri cestino
        if (state.isDirty && state.selectedId) {
            salvaNota().then(function() { caricaCestino(); });
        } else {
            caricaCestino();
        }
    }
}

async function ripristinaNota() {
    if (!state.selectedId) return;
    
    try {
        const resp = await fetch(API_BASE + '/' + state.selectedId + '/ripristina', {
            method: 'POST'
        });
        const data = await resp.json();
        
        if (data.success) {
            toast('Nota ripristinata', 'success');
            await caricaCestino();
        } else {
            toast('Errore: ' + (data.error || ''), 'error');
        }
    } catch (e) {
        toast('Errore di connessione', 'error');
    }
}

async function eliminaDefinitivo() {
    if (!state.selectedId) return;
    
    if (!confirm('Eliminare DEFINITIVAMENTE questa nota?\nNon potr&agrave; essere recuperata.')) return;
    
    try {
        const resp = await fetch(API_BASE + '/' + state.selectedId + '/elimina-definitivo', {
            method: 'POST'
        });
        const data = await resp.json();
        
        if (data.success) {
            toast('Nota eliminata definitivamente', 'info');
            await caricaCestino();
        } else {
            toast('Errore: ' + (data.error || ''), 'error');
        }
    } catch (e) {
        toast('Errore di connessione', 'error');
    }
}

/* ==========================================================================
   ALLEGATI
   ========================================================================== */
function uploadAllegato() {
    if (!state.selectedId || state.isTrashView) return;
    document.getElementById('fileInput').click();
}

async function onFileSelected() {
    const fileInput = document.getElementById('fileInput');
    const files = fileInput.files;
    if (!files || files.length === 0) return;
    
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('allegati', files[i]);
    }
    
    try {
        const resp = await fetch(API_BASE + '/' + state.selectedId + '/allegati', {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();
        
        if (data.success) {
            toast(files.length + ' file allegat' + (files.length === 1 ? 'o' : 'i'), 'success');
            // Ricarica nota per aggiornare allegati
            await caricaNote();
            selezionaNota(state.selectedId);
        } else {
            toast('Errore upload: ' + (data.error || ''), 'error');
        }
    } catch (e) {
        toast('Errore upload', 'error');
    }
    
    fileInput.value = '';
}

async function eliminaAllegato(allegatoId) {
    if (!confirm('Rimuovere questo allegato?')) return;
    
    try {
        const resp = await fetch('/api/note-clienti/allegato/' + allegatoId + '/elimina', {
            method: 'POST'
        });
        const data = await resp.json();
        
        if (data.success) {
            toast('Allegato rimosso', 'info');
            await caricaNote();
            selezionaNota(state.selectedId);
        } else {
            toast('Errore: ' + (data.error || ''), 'error');
        }
    } catch (e) {
        toast('Errore', 'error');
    }
}

function renderAllegati(allegati) {
    const container = document.getElementById('editorAttachments');
    
    if (!allegati || allegati.length === 0) {
        container.style.display = 'none';
        container.innerHTML = '';
        return;
    }
    
    container.style.display = 'block';
    let html = '<small class="text-muted"><i class="bi bi-paperclip"></i> Allegati:</small><br>';
    
    allegati.forEach(function(a) {
        html += '<span class="attachment-item">';
        html += '<a href="/api/note-clienti/allegato/' + a.id + '/scarica" title="Scarica">' + escapeHtml(a.nome_originale) + '</a>';
        if (!state.isTrashView) {
            html += ' <button class="btn-remove-att" onclick="eliminaAllegato(' + a.id + ')" title="Rimuovi"><i class="bi bi-x"></i></button>';
        }
        html += '</span>';
    });
    
    container.innerHTML = html;
}

/* ==========================================================================
   RICERCA
   ========================================================================== */
let searchTimeout = null;

function onSearchInput() {
    const query = document.getElementById('searchInput').value.trim();
    const clearBtn = document.getElementById('searchClear');
    
    clearBtn.classList.toggle('visible', query.length > 0);
    
    clearTimeout(searchTimeout);
    
    if (query.length === 0) {
        // Torna alle note normali
        if (state.view === 'ricerca') {
            caricaNote();
        }
        return;
    }
    
    if (query.length < 2) return;
    
    searchTimeout = setTimeout(function() {
        cercaNote(query);
    }, 300);
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchClear').classList.remove('visible');
    if (state.view === 'ricerca') {
        caricaNote();
    }
}

/* ==========================================================================
   EDITOR - EVENTI
   ========================================================================== */
function onEditorChange() {
    if (state.isTrashView) return;
    
    state.isDirty = true;
    aggiornaIndicatoreSalvataggio('unsaved');
    
    // Autosave dopo 2 secondi di inattivit&agrave;
    clearTimeout(state.saveTimeout);
    state.saveTimeout = setTimeout(function() {
        salvaNota();
    }, 2000);
}

function onClickNota(id) {
    selezionaNota(id);
}

/* ==========================================================================
   UI HELPERS
   ========================================================================== */
function aggiornaIconaPin() {
    const btn = document.getElementById('btnPin');
    if (state.isPinned) {
        btn.innerHTML = '<i class="bi bi-pin-fill"></i>';
        btn.classList.add('pin-active');
        btn.title = 'Sfissa nota';
    } else {
        btn.innerHTML = '<i class="bi bi-pin"></i>';
        btn.classList.remove('pin-active');
        btn.title = 'Fissa nota';
    }
}

function aggiornaIndicatoreSalvataggio(stato) {
    const el = document.getElementById('saveIndicator');
    el.className = 'save-indicator ' + stato;
    
    switch (stato) {
        case 'saved':
            el.innerHTML = '<i class="bi bi-check-circle"></i> Salvato';
            break;
        case 'saving':
            el.innerHTML = '<i class="bi bi-arrow-repeat"></i> Salvataggio...';
            break;
        case 'unsaved':
            el.innerHTML = '<i class="bi bi-circle"></i> Non salvato';
            break;
        case 'error':
            el.innerHTML = '<i class="bi bi-exclamation-circle"></i> Errore';
            break;
    }
}

/* ==========================================================================
   TOAST (sostituto di alert)
   ========================================================================== */
function toast(messaggio, tipo) {
    tipo = tipo || 'info';
    const container = document.getElementById('toastContainer');
    
    const icons = { success: 'bi-check-circle', error: 'bi-exclamation-circle', info: 'bi-info-circle' };
    
    const el = document.createElement('div');
    el.className = 'note-toast ' + tipo;
    el.innerHTML = '<i class="bi ' + (icons[tipo] || 'bi-info-circle') + '"></i> ' + escapeHtml(messaggio);
    
    container.appendChild(el);
    
    setTimeout(function() {
        el.style.opacity = '0';
        el.style.transition = 'opacity 0.3s';
        setTimeout(function() { el.remove(); }, 300);
    }, 3000);
}

/* ==========================================================================
   UTILITY
   ========================================================================== */
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function stripHtml(html) {
    if (!html) return '';
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
}

function formatData(dateStr) {
    if (!dateStr) return '';
    try {
        const d = dateStr.substring(0, 10);
        const parts = d.split('-');
        return parts[2] + '/' + parts[1] + '/' + parts[0];
    } catch (e) {
        return dateStr;
    }
}

// Salva prima di chiudere pagina
window.addEventListener('beforeunload', function(e) {
    if (state.isDirty && state.selectedId && !state.isTrashView) {
        salvaNota();
    }
});
</script>
</body>
</html>
