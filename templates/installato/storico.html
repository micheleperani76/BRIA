{% extends "base.html" %}

{% block title %}Storico Dismessi - Gestione Flotta{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4><i class="bi bi-clock-history"></i> Storico Veicoli Dismessi</h4>
    <a href="/installato" class="btn btn-outline-success btn-sm">
        <i class="bi bi-check-circle-fill"></i> Torna a Installato
    </a>
</div>

<div class="alert alert-info py-2 mb-3">
    <i class="bi bi-info-circle"></i>
    Veicoli INSTALLATO dismessi (contratti scaduti, archiviati dal CRM). Retention: 5 anni.
</div>

<!-- Filtri -->
<div class="card mb-3">
    <div class="card-body py-2">
        <form action="/installato/storico" method="get" class="row g-2 align-items-end">
            <div class="col-md-4">
                <input type="text" name="q" class="form-control form-control-sm"
                       placeholder="Cerca targa, marca, cliente..."
                       value="{{ cerca }}">
            </div>
            <div class="col-md-3">
                <select name="noleggiatore" class="form-select form-select-sm">
                    <option value="">Tutti i noleggiatori</option>
                    {% for n in noleggiatori_lista %}
                    <option value="{{ n }}" {% if filtro_noleggiatore == n %}selected{% endif %}>{{ n }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                    <i class="bi bi-search"></i> Filtra
                </button>
            </div>
            <div class="col-md-1">
                <a href="/installato/storico" class="btn btn-outline-secondary btn-sm w-100">
                    <i class="bi bi-x-lg"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Tabella -->
<div class="card">
    <div class="card-header py-2">
        <i class="bi bi-table"></i> Storico Dismessi ({{ veicoli|length }})
    </div>
    <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Targa</th>
                    <th>Marca / Modello</th>
                    <th>Noleggiatore</th>
                    <th>Cliente</th>
                    <th class="text-center">Inizio</th>
                    <th class="text-center">Scadenza</th>
                    <th class="text-end">Canone</th>
                    <th>Fase</th>
                    <th class="text-center">Retention</th>
                </tr>
            </thead>
            <tbody>
                {% for v in veicoli %}
                <tr>
                    <td><code>{{ v.targa or '-' }}</code></td>
                    <td>
                        <strong>{{ v.marca or '' }}</strong>
                        <small class="text-muted">{{ v.modello or '' }}</small>
                    </td>
                    <td>{{ v.noleggiatore or '-' }}</td>
                    <td>
                        {% if v.cliente_id %}
                        <a href="/cerca/{{ v.p_iva }}" class="text-decoration-none">
                            {{ v.nome_cliente or v.ragione_sociale or '-' }}
                        </a>
                        {% else %}-{% endif %}
                    </td>
                    <td class="text-center" style="white-space: nowrap;"><small>{{ v.inizio or '-' }}</small></td>
                    <td class="text-center" style="white-space: nowrap;"><small>{{ v.scadenza or '-' }}</small></td>
                    <td class="text-end">
                        {% if v.canone %}&euro; {{ v.canone|format_numero }}{% else %}-{% endif %}
                    </td>
                    <td>
                        {% if v.fase_affare %}
                        <small class="text-muted">{{ v.fase_affare }}</small>
                        {% endif %}
                        {% if v.motivazione_chiuso_perso %}
                        <br><small class="text-danger">{{ v.motivazione_chiuso_perso }}</small>
                        {% endif %}
                    </td>
                    <td class="text-center" style="white-space: nowrap;">
                        <small class="text-muted">{{ v.data_scadenza_retention or '-' }}</small>
                    </td>
                </tr>
                {% endfor %}
                {% if not veicoli %}
                <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">Nessun veicolo nello storico</p>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
